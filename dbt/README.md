# DBT Часть проекта: Аналитический конвейер погоды

Этот модуль содержит **DBT (Data Build Tool)** конфигурацию и модели для аналитической трансформации данных о погоде в Калининграде. DBT отвечает за преобразование, очистку и организацию данных в аналитическом хранилище PostgreSQL.

DBT работает как слой **Transform** в ELT-конвейере:
- **Источник**: данные из `PostgreSQL` (`analytics.current_weather`, `analytics.forecasts`)
- **Назначение**: построение агрегированных таблиц, витрин данных и метрик качества прогнозов

## Структура проекта DBT
dbt/
├── dbt_project.yml # Конфигурация проекта
├── packages.yml # Зависимости dbt-пакетов
├── profiles.yml # Профили подключения к БД
├── elementary.yml # Конфигурация elementary
│
├── models/ # SQL-модели
│ ├── stg/ # Стейджинг-модели (очистка и типизация)
│ │ ├── stg_current_weather.sql
│ │ └── stg_forecasts.sql
│ │
│ ├── ods/ # Оперативное хранилище
│ │ ├── ods_forecast_history.sql
│ │ └── ods_weather_history.sql
│ │
│ ├── marts/ # Витрины данных
│ │ ├── dm_daily_stats.sql
│ │ └── dm_forecast_accuracy.sql
│ │
│ └── schema.yml # Общая документация моделей
│
├── tests/ # Кастомные тесты данных
│ └── generic/
│ │ ├── test_is_realistic_temperature.sql
│ │ └── test_valid_humidity_range.sql
└──

## Архитектура DBT

### 1. **Staging (stg) - Бронзовый слой**
- `stg_current_weather.sql` - очистка и типизация фактических данных о погоде
- `stg_forecasts.sql` - подготовка прогнозных данных
- **Материализация**: View
- **Назначение**: Первичная обработка сырых данных, приведение типов, базовые проверки

### 2. **ODS (ods) - Оперативное хранилище**
- `ods_weather_history.sql` - история наблюдений погоды без дублей
- `ods_forecast_history.sql` - история прогнозов погоды
- **Материализация**: Incremental (инкрементальная загрузка)
- **Назначение**: Устранение дубликатов, обеспечение уникальности данных, подготовка для анализа

### 3. **Data Marts (dm) - Серебряный/Золотой слой**
- `dm_daily_stats.sql` - ежедневная статистика по городам
- `dm_forecast_accuracy.sql` - точность прогнозов погоды
- **Материализация**: Incremental
- **Назначение**: Бизнес-витрины, агрегированные данные для аналитики

## Особенности

### **Качество данных**
- **Кастомные тесты**: Проверка реалистичности температуры, корректности влажности
- **Elementary мониторинг**: 
  - Аномалии в данных
  - Freshness тесты (актуальность данных)
  - Volume аномалии (аномалии объема)
  - Schema изменения
  - Дрифт измерений

### **Аналитические метрики**
- **Ежедневная статистика**: Средняя, минимальная, максимальная температура
- **Точность прогнозов**: 
  - Абсолютная ошибка температуры
  - Процентная ошибка
  - Сравнение фактических и прогнозных значений
- **Тренды**: Анализ изменений погодных условий

### **Технические особенности**
- **Инкрементальная загрузка**: Оптимизация производительности
- **Тегирование моделей**: Легкая фильтрация при запуске
- **Уникальные ключи**: Гарантия целостности данных