# –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω–≤–µ–π–µ—Ä –Ω–∞ –±–∞–∑–µ Apache Airflow –∏ Docker

–î–∞–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è —Å–±–æ—Ä–∞, –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –≤ –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥–µ, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã, –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç—å –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:
```
root/
‚îú‚îÄ .env
‚îú‚îÄ .gitignore
‚îú‚îÄ docker-compose.yml
‚îú‚îÄ README.md
‚îú‚îÄ app/
‚îÇ ‚îú‚îÄ Dockerfile
‚îÇ ‚îú‚îÄ requirements.txt
‚îÇ ‚îî‚îÄ main.py
‚îú‚îÄ airflow/
‚îÇ ‚îú‚îÄ Dockerfile
‚îÇ ‚îú‚îÄ requirements-airflow.txt
‚îÇ ‚îú‚îÄ dags/
‚îÇ ‚îÇ ‚îî‚îÄ collect_weather_dag.py
‚îÇ ‚îÇ ‚îî‚îÄ weather_elt.py
‚îÇ ‚îú‚îÄ logs/
‚îÇ ‚îî‚îÄ plugins/
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

–ü—Ä–æ–µ–∫—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç —á–µ—Ä–µ–∑ **Docker Compose** –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å—Ç–µ–∫ –∏–∑ —à–µ—Å—Ç–∏ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:

| –°–µ—Ä–≤–∏—Å | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –†–æ–ª—å |
| :--- | :--- | :--- |
| `app` | FastAPI (Python 3.11) | –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É –∏ 48-—á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥–∞ —á–µ—Ä–µ–∑ OpenWeatherMap API. |
| `mongodb` | Mongo 6 | Landing Zone. –•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. |
| `postgres_analytics` | PostgreSQL 14 | Data Warehouse. –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Ç–∞–±–ª–∏—Ü–∞ `analytics.tickets`). |
| `Airflow Stack` | Apache Airflow | –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è (ELT). –£–ø—Ä–∞–≤–ª—è–µ—Ç DAGs –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è. |
| `postgres` | PostgreSQL 14 | –ë–∞–∑–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö Airflow. |
| `redis` | Redis 7 | –ë—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è Celery Executor Airflow. |

## DAGs

### 1. `collect_weather_data` - DAG —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ï–∂–µ—á–∞—Å–Ω—ã–π —Å–±–æ—Ä –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–µ–µ API.

**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ**: `0 * * * *` (–∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π —á–∞—Å –≤ 00 –º–∏–Ω—É—Ç)

**–ó–∞–¥–∞—á–∏**:

**–î–∞–Ω–Ω—ã–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ –≤ MongoDB**:
- **–¢–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞** (–∫–æ–ª–ª–µ–∫—Ü–∏—è `current_weather`):
  - –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –æ—â—É—â–∞–µ–º–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
  - –í–ª–∞–∂–Ω–æ—Å—Ç—å, –¥–∞–≤–ª–µ–Ω–∏–µ, —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞
  - –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã (—è—Å–Ω–æ, –æ–±–ª–∞—á–Ω–æ, –¥–æ–∂–¥—å –∏ —Ç.–¥.)
  - –í—Ä–µ–º—è —Å–±–æ—Ä–∞ (`collected_ts`)
- **–ü—Ä–æ–≥–Ω–æ–∑—ã** (–∫–æ–ª–ª–µ–∫—Ü–∏—è `forecasts`):
  - –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  - –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Å–∞–¥–∫–æ–≤
  - –í—Ä–µ–º—è –ø—Ä–æ–≥–Ω–æ–∑–∞ (`forecast_dt`) –∏ –≤—Ä–µ–º—è —Å–±–æ—Ä–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ (`collection_dt`)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ OpenWeatherMap API
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å —á–µ—Ä–µ–∑ retry-–ª–æ–≥–∏–∫—É
- –õ–æ–≥–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π

---

### 2. `weather_elt` - –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω–≤–µ–π–µ—Ä (ELT)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∑–∞–≥—Ä—É–∑–∫–∞ –≤ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ —Ä–∞—Å—á–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤.

**–¢—Ä–∏–≥–≥–µ—Ä**: –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `collect_weather_data`

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ELT**:

#### üîÑ **Extract (–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ)**
| –ó–∞–¥–∞—á–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `extract_current_weather` | –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ —Ç–µ–∫—É—â–µ–π –ø–æ–≥–æ–¥–µ –∏–∑ MongoDB –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —á–∞—Å–∞ |
| `extract_forecasts` | –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑—ã –∏–∑ MongoDB –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —á–∞—Å–∞ |

#### üì• **Load (–ó–∞–≥—Ä—É–∑–∫–∞)**
| –ó–∞–¥–∞—á–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `load_current_weather` | –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ –≤ —Ç–∞–±–ª–∏—Ü—É `analytics.current_weather` –≤ PostgreSQL |
| `load_forecasts` | –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü—É `analytics.forecasts` –≤ PostgreSQL |

#### ‚öôÔ∏è **Transform & Analyze (–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –ê–Ω–∞–ª–∏–∑)**
| –ó–∞–¥–∞—á–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `calculate_accuracy_metrics` | –ö–ª—é—á–µ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞. –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑—ã —Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏:<br>‚Ä¢ –ù–∞—Ö–æ–¥–∏—Ç –ø—Ä–æ–≥–Ω–æ–∑—ã, —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –±–æ–ª–µ–µ 1 —á–∞—Å–∞ –Ω–∞–∑–∞–¥<br>‚Ä¢ –ò—â–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è (¬±1 —á–∞—Å)<br>‚Ä¢ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏ |
| `generate_accuracy_report` | –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç –æ –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ |


## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É

–î–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Docker –∏ Docker Compose.

### –ó–∞–ø—É—Å–∫ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:

```bash
docker-compose up -d --build
```

> –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –î–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —á–∏—Å—Ç–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (PostgreSQL –∏ MongoDB), –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ `.env` –∏–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—à–∏–±–æ–∫, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–ª–∞–≥ `-v` (—É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–º–æ–≤): `docker-compose down -v && docker-compose up -d --build`.

### –î–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º

| –ù–∞–∑–≤–∞–Ω–∏–µ                      | –ü–æ—Ä—Ç  | –ê–¥—Ä–µ—Å                                    | –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ          |
| :---------------------------- | :---- | :--------------------------------------- | :---------------------- |
| Airflow Webserver             | 8080  | [—Å—Å—ã–ª–∫–∞](http://89.169.170.56:8080/home) | admin / admin           |
| FastAPI App                   | 8081  | [—Å—Å—ã–ª–∫–∞](http://89.169.170.56:8081/docs) | N/A                     |
| Elementary Dashboard | 8081 | [—Å—Å—ã–ª–∫–∞](http://89.169.170.56:8081/elementary/report)     | N/A |
| Postgres Analytics | 5433  | [—Å—Å—ã–ª–∫–∞](http://89.169.170.56:5433/docs) | readonly / readonlypass |
| Mongo | 27017 | [—Å—Å—ã–ª–∫–∞](http://89.169.170.56:27017)     | readonly / readonlypass |

---

### URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**MongoDB:**

–î–æ—Å—Ç—É–ø–Ω—ã–µ —é–∑–µ—Ä—É –∫–æ–ª–ª–µ–∫—Ü–∏–∏: 
 - current_weather
 - forecasts

–ü—Ä–∏–º–µ—Ä:
```
In: use weather_db
Out: switched to db weather_db

In: <weather_db> db.current_weather.findOne()
Out:
{
  _id: 'f8d1f253-17dc-412c-8ad2-bdfd152d34e6',
  city: 'Kaliningrad',
  country: 'RU',
  dt: 1764872170,
  temp: 18.7,
  feels_like: 16,
  pressure: 1009,
  humidity: 66,
  wind_speed: 1.9,
  wind_deg: 54,
  weather_main: 'Clouds',
  weather_description: '—Å–Ω–µ–≥',
  clouds: 95,
  visibility: 7857,
  collected_ts: ISODate('2025-12-04T18:16:10.443Z')
}
```

```env
MONGO_INITDB_ROOT_USERNAME=readonly
MONGO_INITDB_ROOT_PASSWORD=readonlypass
MONGO_HOST=89.169.170.56
MONGO_PORT=27017
MONGO_INITDB_DATABASE=weather_db

MONGO_URL=mongodb://readonly:readonlypass@89.169.170.56:27017/weather_db?authSource=weather_db
```

**Postgres Analytics:**

```env
POSTGRES_USER=readonly
POSTGRES_PASSWORD=readonlypass
POSTGRES_HOST=89.169.170.56
POSTGRES_PORT=5433
POSTGRES_DB=analytics

POSTGRES_URL=postgresql://readonly:readonlypass@89.169.170.56:5433/analytics
```
