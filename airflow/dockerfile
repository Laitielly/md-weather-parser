FROM apache/airflow:2.7.3-python3.11

USER airflow

# Установка Python зависимостей для Airflow
COPY requirements.txt /requirements.txt
RUN pip install --no-cache-dir -r /requirements.txt

# Установка DBT и его зависимостей (совместимые версии)
RUN pip install --no-cache-dir \
    dbt-core==1.7.16 \
    dbt-postgres==1.7.16 \
    elementary-data==0.14.1

# Копируем DAGs
COPY dags/ /opt/airflow/dags/

# Создаем директорию для DBT (она будет монтирована через volume)
RUN mkdir -p /opt/airflow/dbt

# Настраиваем права
USER root
RUN chown -R airflow:root /opt/airflow
USER airflow